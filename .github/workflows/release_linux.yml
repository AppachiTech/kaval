name: Release Linux

on:
  push:
    tags:
      - 'v*' # Triggers on tags like v0.1.0, v1.0.0

jobs:
  deploy-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Binary (Release)
        run: cargo build --release

      - name: Prepare Artifacts
        run: |
          # Create directory structure for R2
          mkdir -p artifacts/linux/archive

          # Prepare binary
          cp target/release/kav kav

          # Create main tarball (e.g. kav-linux-latest.tar.gz)
          tar -czf artifacts/linux/kav-linux-latest.tar.gz kav LICENSE scripts/uninstall.sh

          # Generate SHA256 checksums
          sha256sum artifacts/linux/kav-linux-latest.tar.gz | awk '{print $1}' > artifacts/linux/kav-linux-latest.tar.gz.sha256

          # Create versioned tarball (e.g. kav-linux-v0.1.0.tar.gz)
          cp artifacts/linux/kav-linux-latest.tar.gz artifacts/linux/archive/kav-linux-${{ github.ref_name }}.tar.gz
          cp artifacts/linux/kav-linux-latest.tar.gz.sha256 artifacts/linux/archive/kav-linux-${{ github.ref_name }}.tar.gz.sha256

      - name: Upload to Cloudflare R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: artifacts
          destination-dir: ./ # Destination prefix in bucket

      - name: Purge Cloudflare CDN Cache
        run: |
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CF_PURGE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "files": [
                "https://downloads.appachi.tech/linux/kav-linux-latest.tar.gz",
                "https://downloads.appachi.tech/linux/kav-linux-latest.tar.gz.sha256"
              ]
            }'

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/linux/archive/kav-linux-${{ github.ref_name }}.tar.gz
            artifacts/linux/archive/kav-linux-${{ github.ref_name }}.tar.gz.sha256
